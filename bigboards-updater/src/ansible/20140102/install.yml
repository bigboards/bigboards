## ####################################################################################################################
## CLEAN UP
## ####################################################################################################################
- hosts: host
  sudo: yes
  tasks:
    - name: be sure the lxc bb-template container is removed
      shell: lxc-destroy -f -n {{item}} removes=/var/lib/lxc/{{item}}
      ignore_errors: yes
      with_items:
        - 'bb-template'
        - '{{ ansible_local.bb.hex.name }}-v{{ ansible_local.bb.node.sequence }}'

    - name: be sure existing tints are uninstalled
      file:
        path: '{{ item }}'
        state: 'absent'
      with_items:
        - /opt/bb/tints.d/stack/
        - /opt/bb/tints.d/dataset/
        - /opt/bb/tints.d/tutor/

## ####################################################################################################################
## NETWORK
## ####################################################################################################################
- hosts: host
  sudo: yes
  tasks:
    - name: be sure the interfaces are configured correctly
      template:
        src: 'templates/{{ item }}'
        dest: '/{{ item }}'
      with_items:
        - 'etc/network/interfaces'
        - 'etc/init.d/networking'
        - 'etc/init/networking.conf'
        - 'etc/resolv.conf'
        - 'etc/dhcp/dhclient.conf'
      notify: Restart Network

  handlers:
    - name: Restart Network
      service:
        name: 'networking'
        state: 'restarted'

## ####################################################################################################################
## HDD
## ####################################################################################################################
- hosts: host
  sudo: yes
  tasks:
    - name: be sure the harddisk is initialized
      shell: creates=/dev/sda1 parted /dev/sda mklabel msdos mkpart primary 0% 100%

    - name: be sure the harddrive filesystem has been created
      shell: creates=/root/.sda1.initialized mkfs.ext4 /dev/sda1 && touch /root/.sda1.initialized

    - name: be sure the data mountpoint exists
      file: state=directory path=/data owner=bb group=bigboards

    - name: be sure the correct FSTAB file is installed
      template: src=templates/etc/fstab dest=/etc/fstab

    - name: be sure the data directory is mounted
      shell: creates=/data/lost+found mount /data

## ####################################################################################################################
## ANSIBLE
## ####################################################################################################################
- hosts: host-coordinators
  sudo: yes
  tasks:
    - name: make sure the ansible ppa is installed
      apt_repository:
        repo: "ppa:ansible/ansible"

    - name: make sure ansible is up to date
      apt:
        name: "ansible"
        update_cache: "yes"
        state: "latest"