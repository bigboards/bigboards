---
- hosts: host
  sudo: yes
  tasks:
    - name: make sure the software is installed
      apt:
        name: "{{ item }}"
        state: "latest"
      with_items:
        - libffi-dev
        - supervisor

    - name: make sure supervisor is started and will start at boot
      service:
        name: "supervisor"
        state: "started"
        enabled: "yes"

    - name: make sure the avahi-daemon init file is up to date
      template:
        src: "templates/etc/init/avahi-daemon.conf"
        dest: "/etc/init/avahi-daemon.conf"

    - name: make sure the avahi configuration file is up to date
      template:
        src: "templates/etc/avahi/avahi-daemon.conf"
        dest: "/etc/avahi/avahi-daemon.conf"

    - name: make sure avahi is started and will start on boot
      service:
        name: "avahi-daemon"
        state: "running"
        enabled: "yes"

    # Ubuntu 14.04 or some install/upgrade seems to break
    # pip in combination with the requests module
    #
    # http://stackoverflow.com/questions/27318535/pip-install-traceback-error-while-installing-packages-in-python
    # https://bugs.launchpad.net/ubuntu/+source/python-pip/+bug/1306991
    #
    # suggested fix = easy_install -U pip
    #
    # Not sure if this is the best approach as we loose control over the exact version that's being installed.
    # Or would if be better to keep our Hexes at the latest Ubuntu version (apt-get upgrade)?
    - name: make sure pip is upgraded
      shell: easy_install -U pip

    - name: make sure butterfly is installed
      pip:
        name: "butterfly"
        state: "present"

    - name: make sure the butterfly supervisord file is up to date
      template:
        src: "templates/etc/supervisor/conf.d/butterfly.conf"
        dest: "/etc/supervisor/conf.d/butterfly.conf"

    - name: make sure butterfly is started
      supervisorctl:
        name: "butterfly"
        state: "started"

- hosts: host-coordinators
  sudo: yes
  tasks:
    - name: make sure the ansible ppa is installed
      apt_repository:
        repo: "ppa:ansible/ansible"

    - name: make sure ansible is up to date
      apt:
        name: "ansible"
        update_cache: "yes"
        state: "latest"
