---
- hosts: host
  sudo: yes
  tasks:
    - name: be sure the serf configuration file is available
      template: src=templates/etc/serf/serf.conf dest=/etc/serf/serf.conf
      notify: Restart Serf

    - name: be sure the harddisk is initialized
      shell: creates=/dev/sda1 parted /dev/sda mklabel msdos mkpart primary 0% 100%

    - name: be sure the harddrive filesystem has been created
      shell: creates=/root/.sda1.initialized mkfs.ext4 /dev/sda1 && touch /root/.sda1.initialized

    - name: be sure the data mountpoint exists
      file: state=directory path=/data owner=bb group=bigboards

    - name: be sure the correct FSTAB file is installed
      copy: src=files/etc/fstab dest=/etc/fstab

    - name: be sure the data directory is mounted
      shell: creates=/data/lost+found mount /data

    - name: be sure the bigboards node is installed
      apt: state=latest name=bigboards-node force=yes update_cache=yes
      notify: Restart BigBoards Node

  handlers:
    - name: Restart BigBoards Node
      service: state=restarted name=bigboards-node
    - name: Restart Serf
      service: state=restarted name=serf


- hosts: host-coordinators
  sudo: yes
  tasks:
    - name: be sure the bigboards management console is installed
      apt: state=latest name={{item}} force=yes update_cache=yes
      with_items:
        - bigboards-mmc
      notify: Restart BigBoards Management Console
  handlers:
    - name: Restart BigBoards Management Console
      service: state=restarted name=bigboards-mmc