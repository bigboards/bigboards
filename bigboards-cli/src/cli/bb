#!/bin/bash
# -- ----------------------------------------------------------------------- --
# -- bb : BigBoards management script
# -- ----------------------------------------------------------------------- --
ACTION=${1}
OPERATION=${2}
DIR=$(dirname "$(readlink -f ${BASH_SOURCE[0]})" )

if [[ $EUID -eq 0 ]];
then
   echo "The BB command may not be run as root"
   exit 1
fi

# Check if the hosts file exists inside the /opt/bb directory
HOSTSFILE=/opt/bb/hosts
[ ! -f "$HOSTSFILE" ] && HOSTSFILE=/etc/ansible/hosts
PLAYBOOK="ansible-playbook -i ${HOSTSFILE}"

askForInit() {
    echo
    echo
    echo "################################################################################"
    echo "##                                                                            ##"
    echo "##                            I M P O R T A N T                               ##"
    echo "##                                                                            ##"
    echo "##     The cluster has not been initialized yet. You can do so by running     ##"
    echo "##                                                                            ##"
    echo "##                             bb system init                                 ##"
    echo "##                                                                            ##"
    echo "################################################################################"
    echo
    echo
}


usage() {
    echo "Usage: $0 [firmware|network|run|mmc|container|system|help]" 1>&2; exit 1;
}

verifyPrerequisites() {
    if [ "$ACTION" = "system" ] && [ "$OPERATION" = "init" ]; then
        return
    fi

    if [ ! -e "/usr/bin/ansible" ] || [ ! -e "/etc/ansible/hosts" ]; then
        askForInit
        exit 1
    else
        VALID_ANSIBLE_HOSTS=$(grep "\[host-coordinators\]" /etc/ansible/hosts | wc -l)
        if [ "$VALID_ANSIBLE_HOSTS" == "0" ]; then
            askForInit
            exit 1
        fi
    fi
}

requestPowerCycle() {
    echo
    echo
    echo "################################################################################"
    echo "##                                                                            ##"
    echo "##                            I M P O R T A N T                               ##"
    echo "##                                                                            ##"
    echo "##   You must powercycle the hex in order for the changes to be picked up!    ##"
    echo "##                                                                            ##"
    echo "################################################################################"
    echo
    echo
}

validateTintBuilder() {
    [ ! -e "${HOME}/.tint-builder" ] && echo "No .tint-builder file found in the home directory of ${USER} " && exit 8;
    source "${HOME}/.tint-builder"

    [ -z "${BB_USERNAME}" ] && echo "BB_USERNAME not set" && exit 7;
    [ -z "${BB_EMAIL}" ] && echo "BB_EMAIL not set" && exit 7;
    [ -z "${BB_PASSWORD}" ] && echo "BB_PASSWORD not set" && exit 7;
}

update() {
    sudo apt-get update
    sudo apt-get install -y --force-yes bigboards-updater bigboards-cli bigboards-mmc

    AVAILABLE_PATCHES="$(ls /opt/bb/runtimes/bigboards-updater/patches)"
    CURRENT_VERSION=

    if [ -f /opt/bb/.versions ]
    then
        CURRENT_VERSION="$(tail -n 1 /opt/bb/.versions | cut -d '|' -f1)"
    fi

    for p in ${AVAILABLE_PATCHES}
    do
        if [ -z "${CURRENT_VERSION}" ] || [ "${p}" -gt "${CURRENT_VERSION}" ]
        then
            # check if there is a more specific install file available
            INSTALL_FILE="/opt/bb/runtimes/bigboards-updater/patches/${p}/install-$(uname -m).yml"

            # fallback to the default install file if the specific one does not exist
            if [ ! -f "$INSTALL_FILE" ]; then
                INSTALL_FILE="/opt/bb/runtimes/bigboards-updater/patches/${p}/install.yml"
            fi

            echo "Invoking patch ${p} using $INSTALL_FILE"
            ${PLAYBOOK} ${INSTALL_FILE} && echo "${p}|$(date)" >> /opt/bb/.versions

            [ "$?" -ne "0" ] && echo "Something went wrong when invoking patch ${p}. Have a look at the output above to figure out what went wrong." && break;
        fi
    done

    sudo service bigboards-mmc restart
}

verifyPrerequisites

case "${ACTION}" in
    firmware)
        case "${2}" in
            upgrade)
                [ -z "${3}" ] && echo "No target version provided! Please specify this as 3rd parameter ..." && usage

                ${PLAYBOOK} --extra-vars "version=${3}" ${DIR}/ansible/firmware/upgrade/main.yml
                ;;
            update)
                update
                ;;
            help|*)
                cat <<-EOF
Manage the software version on the hex.

USAGE: $0 firmware [upgrade|update|help] [arguments]

OPTIONS

    update  Update the software version on the hex. An update is a smaller update of some of the
            functionality of the hex.


    upgrade Upgrade to a new release of the software. A release is different from an update
            and is considered to be a major upgrade.

            arguments:
                release-name     The name of the release to upgrade to


    help    Show this help message

EOF
                ;;
        esac
        ;;
    network)
        case "${2}" in
            switch)
                rx='([1-9]?[0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])'

                if [[ -z $3 || -z $4 || -z $5 ]]; then
                    echo "No range, prefix and interface have been provide"
                    exit 1
                fi

                if [[ ! $3 =~ ^$rx\.$rx\.$rx$ ]]; then
                    echo "Invalid network range!"
                    echo "  expected format: <1-255>.<0-255>.<0-255>"
                    exit 1
                fi

                if [[ ! $4 =~ ^$rx\.$rx\.$rx\.$rx$ ]]; then
                    echo "Invalid network mask!"
                    echo "  expected format: <1-255>.<0-255>.<0-255>.<0-255>"
                    exit 1
                fi

                if [[ ! -e /sys/class/net/$5 ]]; then
                    echo "Invalid network interface!"
                    echo "  valid network interfaces: $(ls /sys/class/net)"
                    exit 1
                fi

                ansible-playbook ${DIR}/ansible/network/switch/switch_network.yml --extra-vars "network_range=${3} network_mask=${4} itf=${5}"

                [ $? -eq 0 ] && requestPowerCycle
                ;;
            proxy)
                echo -n "Please enter the address of your HTTP proxy server [eg. my-proxy.my-domain.com]: "
                read HTTP_PROXY_HOST

                echo -n "Please enter the port of your HTTP proxy server [eg. 8080]: "
                read HTTP_PROXY_PORT

                echo -n "Please enter the address of your HTTPS proxy server [eg. my-proxy.my-domain.com]: "
                read HTTPS_PROXY_HOST

                echo -n "Please enter the port of your HTTPS proxy server [eg. 8080]: "
                read HTTPS_PROXY_PORT

                ansible-playbook ${DIR}/ansible/network/proxy/set_proxy.yml --extra-vars "http_proxy_host=${HTTP_PROXY_HOST} http_proxy_port=${HTTP_PROXY_PORT} https_proxy_host=${HTTPS_PROXY_HOST} https_proxy_port=${HTTPS_PROXY_PORT}"
                ;;
            help|*)
                cat <<-EOF
Manage the network.

USAGE: $0 network [switch|help] [arguments]

OPTIONS

    switch  Switch the internal network. This is an important step when using multiple
            hexes in the same network.

            arguments:
                range         The network prefix to use. This is the first 3 numbers of your
                              ip address. Valid examples are 172.21.3 or 192.168.1
                mask          The netmask to use. this usually is something like 255.255.255.0,
                              255.255.0.0 or 255.0.0.0
                itf           The name of the physical network interface


    help    Show this help message

EOF
                ;;
        esac
        ;;
    run)
        ansible host -i /opt/bb/hosts --sudo -m shell -a "$2"
        ;;
    mmc)
        sudo service bigboards-mmc $2
        ;;
    container)
        case "${2}" in
            list)
                sudo docker ps
                ;;
            attach)
                sudo docker exec -it $3 /bin/bash
                ;;
            tail)
                sudo docker logs --tail=100 -f $3
                ;;
            build)
                validateTintBuilder

                ARCH=$(uname -m)
                GIT_URL=$3
                SLUG=$4

                echo "Logging into the docker hub"
                sudo docker login -e ${BB_EMAIL} -u ${BB_USERNAME} -p ${BB_PASSWORD}

                [ ! -e ~/build ] && mkdir ~/build
                pushd ~/build
                if [ -e "${SLUG}" ];
                then
                    pushd ${SLUG}
                    git pull
                    popd
                else
                    git clone ${GIT_URL} ${SLUG}
                fi

                for D in `find ${SLUG}/docker -mindepth 1 -type d`
                do
                    sed -i -- "s/__arch__/${ARCH}/g" ${D}/Dockerfile

                    CONTAINER_NAME="$(basename $D)"
                    IMAGE_NAME="${BB_USERNAME}/${CONTAINER_NAME}-${ARCH}:latest"

                    echo "Building ${IMAGE_NAME}"
                    sudo -E docker build -t ${IMAGE_NAME} ${D}

                    echo "Pushing ${IMAGE_NAME}"
                    sudo -E docker push ${IMAGE_NAME}
                done

                popd
                ;;
            help|*)
                cat <<-EOF
Manage the docker containers.

USAGE: $0 container [list|attach|tail|build|help] [arguments]

OPTIONS

    list    List the available containers


    attach  Attach the terminal to the container with the given name

            arguments:
                container-name     The name of the container to connect to


    tail    Follow the output of the container with the given name

            arguments:
                container-name     The name of the container to connect to


    build   Build the docker containers for the tint with the given git url. We will look for a
            folder named 'docker' inside the repository. We will consider each subfolder of the
            docker folder a repository.

            arguments:
                git-url           The url pointing to the git repository. The git url can be one
                                  from github, bitbucket or any other valid url which can be passed
                                  to the git clone command.
                folder-name       The name of the folder hosting the tint files.


    help    Show this help message

EOF
                ;;
            *)
        esac
        ;;
    system)
        case "${2}" in
            init)
                # -- get the cluster name
                read -r -p "What is the name of this cluster? " CLUSTER_NAME

                # -- get the number of nodes
                read -r -p "How many nodes are in this cluster? " NODE_COUNT
                re='^[0-9]+$'
                while ! [[ $NODE_COUNT =~ $re ]] ; do
                   read -r -p "How many nodes are in this cluster? " NODE_COUNT
                done

                sudo apt-get install -y software-properties-common
                sudo apt-add-repository -y ppa:ansible/ansible
                sudo apt-get update
                sudo apt-get install -y ansible

                cat > /tmp/ansible_hosts << EOF
[local]
localhost   connection=local

[host:children]
host-coordinators
host-workers

[host-coordinators]
${CLUSTER_NAME}-n1   ansible_ssh_user=bb

[host-workers]
EOF

                for i in $(seq 2 ${NODE_COUNT}); do
                    echo "${CLUSTER_NAME}-n${i}     ansible_ssh_user=bb" >> /tmp/ansible_hosts
                done

                sudo mv /tmp/ansible_hosts /etc/ansible/hosts

                exit $?

                ;;
            bootstrap)
                ${PLAYBOOK} ${DIR}/ansible/system/bootstrap/bootstrap.yml

                [ $? -eq 0 ] && requestPowerCycle
                ;;
            purge)
                ${PLAYBOOK} ${DIR}/ansible/system/purge/purge.yml
                ;;
            purge-legacy)
                ${PLAYBOOK} ${DIR}/ansible/system/purge/purge-legacy.yml
                ;;
            version)
                WIRELESS_CHIP=$(cat /sys/bus/sdio/devices/mmc1\:0001\:1/device)
                if [ "$WIRELESS_CHIP" == "0x4329" ]; then
                    echo "B1"
                elif [ "$WIRELESS_CHIP" == "0x4330"  ]; then
                    echo "C1"
                else
                    echo "unknown"
                fi
                ;;
            help|*)
                cat <<-EOF
Manage the system.

USAGE: $0 system [purge|version|help]

OPTIONS

    bootstrap   Bootstrap the system. This should only be needed the first time you boot the hex.

    init        Initialize the cluster.

    purge       Clear the system from all containers and state. You will end up with a
                pristine system to start from.


    version     Show the hardware revision


    help        Show this help message

EOF
                ;;
        esac
        ;;
    help|*)
        cat <<-EOF
Interact with the hex.

USAGE: $0 [firmware|network|run|mmc|container|system|help]

OPTIONS

    firmware    Manage the hex firmware.
    network     Manage the network.
    run         Run a command on all nodes of the hex.
    mmc         Pass a command to the mmc daemon.
    container   Manage the docker containers.
    system      Manage the system.
    help        Show this help message

EOF
        ;;
esac
