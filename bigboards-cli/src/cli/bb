#!/bin/bash
# -- ----------------------------------------------------------------------- --
# -- bb : BigBoards management script
# -- ----------------------------------------------------------------------- --

ACTION=${1}
PLAYBOOK="ansible-playbook -i /opt/bb/hosts"
DIR=$(dirname "$(readlink -f ${BASH_SOURCE[0]})" )

usage() {
    echo "Usage: $0 [help|switch]" 1>&2; exit 1;
}

update() {
    sudo apt-get update
    sudo apt-get install -y --force-yes bigboards-updater bigboards-cli bigboards-mmc

    AVAILABLE_PATCHES="$(ls /opt/bb/runtimes/bigboards-updater/patches)"
    CURRENT_VERSION=

    if [ -f /opt/bb/.versions ]
    then
        CURRENT_VERSION="$(tail -n 1 /opt/bb/.versions | cut -d '|' -f1)"
    fi

    for p in $AVAILABLE_PATCHES
    do
        if [ -z "${CURRENT_VERSION}" ] || [ "${p}" -gt "${CURRENT_VERSION}" ]
        then
            echo "Invoking patch ${p}"
            ${PLAYBOOK} /opt/bb/runtimes/bigboards-updater/patches/${p}/install.yml && echo "${p}|$(date)" >> /opt/bb/.versions

            [ "$?" -ne "0" ] && echo "Something went wrong when invoking patch ${p}. Have a look at the output above to figure out what went wrong." && break;
        fi
    done
}

case "${ACTION}" in
    switch)
        case "${2}" in
            version)
                ${PLAYBOOK} --extra-vars "version=${3}" ${DIR}/ansible/switch_version.yml
                ;;
            network)
                # validate the given network prefix
                if [[ ! $3 =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
                    echo "Invalid network prefix! please specify a network prefix as xxx.xxx.xxx"
                    exit 3
                fi

                ${PLAYBOOK} --extra-vars "ip_prefix=${3}" ${DIR}/ansible/switch_ip/switch_ip.yml
                ;;
            *)
                echo "Invalid switch action '${2}'"
                usage
                ;;
        esac
        ;;
    run)
        ansible host -i /opt/bb/hosts --sudo -m shell -a "$2"
        ;;
    update)
        update
        ;;
    help)
        usage
        ;;
    *)
        echo "Invalid action '$ACTION'"
        usage
        ;;
esac