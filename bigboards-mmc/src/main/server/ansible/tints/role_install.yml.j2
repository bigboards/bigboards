{% if item.pre_install is defined %}{{ lookup('file', tint.path + '/' + item.pre_install) }}{% endif %}

- name: make sure the role data directory exists
  file:
    state: "directory"
    path: "{{'{{'}} data_path {{'}}'}}/{{ item.name }}"
    owner: bb
    mode: 0755

###############################################################################
##
## Volumes
##
###############################################################################

- name: make sure the role template directory exists
  file:
    state: "directory"
    path: "{{'{{'}} config_path {{'}}'}}/{{ item.name }}"

- name: make sure the role template directory is empty
  shell: "rm -rf {{'{{'}} config_path {{'}}'}}/{{ item.name }}/*"

- name: make sure the configuration files are available
  template:
    src: "{{ '{{' }} item {{ '}}' }}"
    dest: "{{'{{'}} config_path {{'}}'}}/{{ item.name }}/"
  with_fileglob:
    - ../templates/*

- name: make sure the docker image is the latest one
  sudo: yes
  shell: docker pull {{ item.image }}-{{ansible_machine}}

###############################################################################
##
## Docker
##
###############################################################################

- name: make sure the container exists
  sudo: yes
  docker:
    docker_api_version: "1.15"
    name: "{{ item.name }}"
    net: "host"
    ports:
{% for port in item.ports %}
      - "{{port.host}}:{{port.container}}"
{% endfor %}
    publish_all_ports: "yes"
    volumes:
      - "{{ '{{' }} tmp_path {{ '}}/' + item.name }}:/tmp"
      - "{{ '{{' }} data_path {{ '}}/' + item.name }}:/data"
{% for volume in item.volumes %}
      - "{{ '{{' }} config_path {{ '}}/' + volume.host }}:{{volume.container}}"
{% endfor %}
    image: "{{docker_registry}}/{{ item.image }}-{{ansible_machine}}"
    command: "{{ item.command }}"
    state: running
{% if item.environment is defined %}
    env:
  {% for envVar in item.environment %}
      {{envVar.key}}: "{{envVar.value}}"
  {% endfor %}
{% endif %}

- name: make sure the init file is available
  copy: src={{ item.name }}.conf dest=/etc/init/{{ item.name }}.conf
  sudo: yes

- name: make sure the service is started at boot
  service: name={{ item.name }} enabled=yes state=started
  sudo: yes

{% if item.post_install is defined %}{{ lookup('file', tint.path + '/' + item.post_install) }}{% endif %}